name: Create EC2 Instance

on:
  push:
    branches:
      - main

env:
  AWS_REGION: us-east-1
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  INSTANCE_USER: ubuntu

jobs:
  create_ec2_instance:
    runs-on: ubuntu-latest
    steps:
      - name: Create EC2 instance
        uses: machulav/ec2-github-runner@v2.3.4
        with:
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws_region: ${{ env.AWS_REGION }}
          instance_type: t2.micro
          instance_name: github
          instance_user: ${{ env.INSTANCE_USER }}
          instance_key_name: private_key.pem

      - name: Wait for EC2 instance to start
        run: |
          aws ec2 wait instance-running --filters "Name=tag:Name,Values=github"

      - name: Get EC2 instance IP
        run: |
          INSTANCE_IP=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=github" --query "Reservations[0].Instances[0].PublicIpAddress" --output text)
          echo "EC2 instance IP: $INSTANCE_IP"

      - name: Connect to EC2 instance
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ env.INSTANCE_USER }}@$INSTANCE_IP 'echo "Connected to EC2 instance"'
